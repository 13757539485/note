<!doctype html>
<html lang="zh-CN">
 <head>
  <meta charset="utf-8">
  <link rel="canonical" href="https://blog.csdn.net/qq_35584878/article/details/129006112">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="report" content="{&quot;pid&quot;: &quot;blog&quot;, &quot;spm&quot;:&quot;1001.2101&quot;}">
  <meta name="referrer" content="always">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <link rel="alternate" media="handheld" href="#">
  <meta name="shenma-site-verification" content="5a59773ab8077d4a62bf469ab966a63b_1497598848">
  <meta name="applicable-device" content="pc">
  <link href="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/static/logo/favicon32.ico" rel="shortcut icon" type="image/x-icon">
  <title>Android12 Launcher3 最近任务客制化-CSDN博客</title>
  <meta name="keywords" content="launcher3 最近任务">
  <meta name="csdn-baidu-search" content="{&quot;autorun&quot;:true,&quot;install&quot;:true,&quot;keyword&quot;:&quot;launcher3 最近任务&quot;}">
  <meta name="description" content="文章浏览阅读2.4k次。本文详细介绍了如何定制Android12的Launcher3，包括修改最近任务的图标位置，添加应用名称，调整边距，将多任务背景改为壁纸，修改Task预览图的圆角半径，以及移动和添加清除全部按钮。同时，文章还讨论了最近任务为空时的显示，缩放效果的实现以及在实现过程中遇到的bug及其解决方案。">
  <link rel="stylesheet" type="text/css" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/css/detail_enter-a3d976e9c4.min.css">
  <link rel="stylesheet" type="text/css" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/themesSkin/skin-shirtblue/skin-shirtblue-b2ba816980.min.css">
  <script src="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/lib/jquery/1.12.4/jquery.min.js" type="text/javascript"></script>
  <meta name="toolbar" content="{&quot;type&quot;:&quot;0&quot;,&quot;fixModel&quot;:&quot;1&quot;}">
  <link rel="stylesheet" type="text/css" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/public/sandalstrap/1.4/css/sandalstrap.min.css">
  <style>
        .MathJax, .MathJax_Message, .MathJax_Preview{
            display: none
        }
    </style>
 </head>
 <body class="nodata  " style="">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/css/blog_code-01256533b5.min.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/chart-3456820cac.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/lib/swiper/6.0.4/css/swiper.css"><div class="main_father clearfix d-flex justify-content-center mainfather-concision" style="height:100%;"><div class="container clearfix container-concision" id="mainBox">
    <main>
     <div class="blog-content-box"><div class="article-header-box"><div class="article-header"><div class="article-title-box">
         <h1 class="title-article" id="articleContentId">Android12 Launcher3 最近任务客制化</h1></div><div class="article-info-box"><div class="up-time">
          最新推荐文章于&nbsp;2023-08-23 05:11:18&nbsp;发布</div><div class="article-bar-top"><img class="article-type-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/original.png" alt=""><div class="bar-content"><a href="https://mall.csdn.net/vip" data-report-query="spm=3001.10404" data-report-click="{&quot;spm&quot;:&quot;3001.10404&quot;}" data-report-view="{&quot;spm&quot;:&quot;3001.10404&quot;}" class="article-vip-box" target="_blank"><img class="article-vip-img-new" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/identityVipNew.png" alt=""></a> <a class="follow-nickName " href="https://blog.csdn.net/qq_35584878" target="_blank" rel="noopener" title="侠亦狐">侠亦狐</a> <img class="article-time-img article-heard-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/newCurrentTime2.png" alt=""> <span class="time blog-postTime" data-time="2023-02-13 12:03:37">最新推荐文章于&nbsp;2023-08-23 05:11:18&nbsp;发布</span>
           <div class="read-count-box"><img class="article-read-img article-heard-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/articleReadEyes2.png" alt=""> <span class="read-count">阅读量2.4k</span> <a id="blog_detail_zk_collection" class="un-collection" data-report-click="{&quot;mod&quot;:&quot;popu_823&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4232&quot;,&quot;ab&quot;:&quot;new&quot;}"> <img class="article-collect-img article-heard-img un-collect-status isdefault" style="display:inline-block" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/tobarCollect2.png" alt=""> <img class="article-collect-img article-heard-img collect-status isactive" style="display:none" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/tobarCollectionActive2.png" alt=""> <span class="name">收藏</span> <span class="get-collection"> 7 </span> </a>
            <div class="read-count-box is-like"><img class="article-read-img article-heard-img" style="display:none" id="is-like-imgactive-new" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/newHeart2023Active.png" alt=""> <img class="article-read-img article-heard-img" style="display:block" id="is-like-img-new" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/newHeart2023Black.png" alt=""> <span class="read-count" id="blog-digg-num">点赞数 </span></div></div></div></div><div class="blog-tags-box"><div class="tags-box artic-tag-box"><span class="label">分类专栏：</span> <a class="tag-link" href="https://blog.csdn.net/qq_35584878/category_8641949.html" target="_blank" rel="noopener">Android</a> <span class="label">文章标签：</span> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;多任务&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;多任务\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;多任务&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;多任务\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E5%A4%9A%E4%BB%BB%E5%8A%A1&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">多任务</a> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;最近任务&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;最近任务\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;最近任务&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;最近任务\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E6%9C%80%E8%BF%91%E4%BB%BB%E5%8A%A1&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">最近任务</a> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;Android&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;Android\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;Android&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;Android\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=Android&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">Android</a> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;launcher&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;launcher\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;launcher&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;launcher\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=launcher&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">launcher</a> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;SystemUI&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;SystemUI\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;SystemUI&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;SystemUI\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=SystemUI&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">SystemUI</a></div></div><div class="slide-content-box"><div class="article-copyright"><div class="creativecommons">
            版权声明：本文为博主原创文章，遵循<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener"> CC 4.0 BY-SA </a>版权协议，转载请附上原文出处链接和本声明。</div><div class="article-source-link">
            本文链接：<a href="https://blog.csdn.net/qq_35584878/article/details/129006112" target="_blank">https://blog.csdn.net/qq_35584878/article/details/129006112</a></div></div></div><div class="operating"><a class="href-article-edit slide-toggle">版权</a></div></div></div></div><div id="blogHuaweiyunAdvert"></div><div class="ai-abstract-box"><div class="ai-abstract"><div class="abstract-content"><img class="lock-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/img-home/images/20240711042549.png" alt=""> 本文详细介绍了如何定制Android12的Launcher3，包括修改最近任务的图标位置，添加应用名称，调整边距，将多任务背景改为壁纸，修改Task预览图的圆角半径，以及移动和添加清除全部按钮。同时，文章还讨论了最近任务为空时的显示，缩放效果的实现以及在实现过程中遇到的bug及其解决方案。</div> <span>摘要由CSDN通过智能技术生成</span></div></div>
      <article class="baidu_pl"><div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-704d5b9767.css"><div id="content_views" class="htmledit_views">
         <p>实现的最终效果:</p>
         <p><img alt="" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/blog_migrate/cf555847fc0941ef257600092235e899.png"></p>
         <p>&nbsp;</p>
         <p id="main-toc"><strong>目录</strong></p>
         <p id="%E4%BF%AE%E6%94%B9%E5%9B%BE%E6%A0%87%E4%BD%8D%E7%BD%AE%2B%E6%B7%BB%E5%8A%A0%E5%BA%94%E7%94%A8%E5%90%8D%E7%A7%B0-toc" style="margin-left:0px;"><a href="#%E4%BF%AE%E6%94%B9%E5%9B%BE%E6%A0%87%E4%BD%8D%E7%BD%AE%2B%E6%B7%BB%E5%8A%A0%E5%BA%94%E7%94%A8%E5%90%8D%E7%A7%B0" rel="nofollow">修改图标位置+添加应用名称</a></p>
         <p id="%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%EF%BC%9A" rel="nofollow">代码实现：</a></p>
         <p id="%E5%9B%BE%E6%A0%87%E6%8E%A7%E4%BB%B6%E7%9A%84%E8%BE%B9%E8%B7%9D%E8%B0%83%E6%95%B4%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%9B%BE%E6%A0%87%E6%8E%A7%E4%BB%B6%E7%9A%84%E8%BE%B9%E8%B7%9D%E8%B0%83%E6%95%B4%EF%BC%9A" rel="nofollow">图标控件的边距调整：</a></p>
         <p id="%E5%A4%9A%E4%BB%BB%E5%8A%A1%E8%83%8C%E6%99%AF%E6%94%B9%E6%88%90%E5%A3%81%E7%BA%B8-toc" style="margin-left:0px;"><a href="#%E5%A4%9A%E4%BB%BB%E5%8A%A1%E8%83%8C%E6%99%AF%E6%94%B9%E6%88%90%E5%A3%81%E7%BA%B8" rel="nofollow">多任务背景改成壁纸</a></p>
         <p id="%E4%BF%AE%E6%94%B9Task%E9%A2%84%E8%A7%88%E5%9B%BE%E7%9A%84%E5%9C%86%E8%A7%92%E5%8D%8A%E5%BE%84%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E4%BF%AE%E6%94%B9Task%E9%A2%84%E8%A7%88%E5%9B%BE%E7%9A%84%E5%9C%86%E8%A7%92%E5%8D%8A%E5%BE%84%EF%BC%9A" rel="nofollow">修改Task预览图的圆角半径：</a></p>
         <p id="%E6%B8%85%E9%99%A4%E5%85%A8%E9%83%A8%E6%8C%89%E9%92%AE%E7%A7%BB%E5%8A%A8%E5%88%B0%E5%BA%95%E9%83%A8%E6%98%BE%E7%A4%BA-toc" style="margin-left:0px;"><a href="#%E6%B8%85%E9%99%A4%E5%85%A8%E9%83%A8%E6%8C%89%E9%92%AE%E7%A7%BB%E5%8A%A8%E5%88%B0%E5%BA%95%E9%83%A8%E6%98%BE%E7%A4%BA" rel="nofollow">清除全部按钮移动到底部显示</a></p>
         <p id="%E9%A6%96%E5%85%88%E9%9A%90%E8%97%8F%E5%8E%9F%E6%9C%89%E7%9A%84%E6%B8%85%E9%99%A4%E6%8C%89%E9%92%AE%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E9%A6%96%E5%85%88%E9%9A%90%E8%97%8F%E5%8E%9F%E6%9C%89%E7%9A%84%E6%B8%85%E9%99%A4%E6%8C%89%E9%92%AE%EF%BC%9A" rel="nofollow">首先隐藏原有的清除按钮：</a></p>
         <p id="%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E5%BA%95%E9%83%A8%E6%B8%85%E9%99%A4%E5%85%A8%E9%83%A8%E6%8C%89%E9%92%AE%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E5%BA%95%E9%83%A8%E6%B8%85%E9%99%A4%E5%85%A8%E9%83%A8%E6%8C%89%E9%92%AE%EF%BC%9A" rel="nofollow">添加新的底部清除全部按钮：</a></p>
         <p id="%E6%9C%80%E8%BF%91%E4%BB%BB%E5%8A%A1%E4%B8%BA%E7%A9%BA%E6%97%B6%E7%9A%84%E5%9B%BE%E7%89%87%E3%80%81%E5%AD%97%E4%BD%93%E9%A2%9C%E8%89%B2%E7%AD%89-toc" style="margin-left:0px;"><a href="#%E6%9C%80%E8%BF%91%E4%BB%BB%E5%8A%A1%E4%B8%BA%E7%A9%BA%E6%97%B6%E7%9A%84%E5%9B%BE%E7%89%87%E3%80%81%E5%AD%97%E4%BD%93%E9%A2%9C%E8%89%B2%E7%AD%89" rel="nofollow">最近任务为空时的图片、字体颜色等</a></p>
         <p id="%E7%BC%A9%E6%94%BE%E6%95%88%E6%9E%9C-toc" style="margin-left:0px;"><a href="#%E7%BC%A9%E6%94%BE%E6%95%88%E6%9E%9C" rel="nofollow">缩放效果</a></p>
         <hr id="hr-toc">
         <p></p>
         <h2></h2>
         <h2 id="%E4%BF%AE%E6%94%B9%E5%9B%BE%E6%A0%87%E4%BD%8D%E7%BD%AE%2B%E6%B7%BB%E5%8A%A0%E5%BA%94%E7%94%A8%E5%90%8D%E7%A7%B0">修改图标位置+添加应用名称</h2>
         <p>修改类：com.android.quickstep.views.IconView.java</p>
         <p>把应用名称放到图标右边，方案：自定义view在onDraw里面canvas.drawText</p>
         <h4 id="%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%EF%BC%9A">代码实现：</h4>
         <p>增加字段：</p>
         <pre class="set-code-show"><code class="language-java">//增加应用名称
private String mText;
private Paint mTxtPain;
private int mTextMargins;</code></pre>
         <p>在构造函数里面增加初始化的方法initView()，初始化画笔的属性：</p>
         <pre class="set-code-show"><code class="language-java">private void initView() {
    mTxtPain = new Paint();
    mTxtPain.setColor(ContextCompat.getColor(getContext(), R.color.recent_task_text));//字体颜色
    mTxtPain.setFlags(Paint.ANTI_ALIAS_FLAG);
    mTxtPain.setTextSize(getResources().getDimension(R.dimen.notification_main_title_size));//自己定义字体字号
    mTxtPain.setTextAlign(Paint.Align.LEFT);//左对齐

    mTextMargins = (int) getResources().getDimension(R.dimen.task_thumbnail_icon_margin);//10dp
}</code></pre>
         <p>增加提供给外部调用设置文本方法：</p>
         <pre class="set-code-show"><code class="language-java">//这里设置完文本后面图片资源会去绘制，所以这里不需要invalidate来重复绘制一遍
public void setText(String text){
    setText(text,false);
}
//如果在绘制完图标图片资源之后还想要修改文本，则需要重新绘制，需要invalidate传true
public void setText(String text,boolean invalidate){
    this.mText = text;
    if(invalidate){
        invalidate();
    }
}</code></pre>
         <p>修改图标的位置：</p>
         <pre class="set-code-show"><code class="language-java">private void setDrawableSizeInternal(int selfWidth, int selfHeight) {
    Rect selfRect = new Rect(0, 0, selfWidth, selfHeight);
    Rect drawableRect = new Rect();
    //Gravity.apply(Gravity.CENTER, mDrawableWidth, mDrawableHeight, selfRect, drawableRect); //原先是居中对齐
    Gravity.apply(Gravity.START, mDrawableWidth, mDrawableHeight, selfRect, drawableRect); //修改为左对齐
    mDrawable.setBounds(drawableRect);
}</code></pre>
         <p>绘制App名称文本：</p>
         <pre class="set-code-show"><code class="language-java">@Override
protected void onDraw(Canvas canvas) {
    if (mDrawable != null) {
        mDrawable.draw(canvas);
    }

    if(mText != null) {
        Paint.FontMetrics fontMetrics = mTxtPain.getFontMetrics();
        float top = fontMetrics.top;//为基线到字体上边框的距离
        float bottom = fontMetrics.bottom;//为基线到字体下边框的距离
        int textLeft = mDrawableWidth + mTextMargins;
        int baseLineY = (int) (getHeight()/2 + (bottom - top)/2 - bottom);
        canvas.drawText(mText, textLeft, baseLineY, mTxtPain);
    }
}</code></pre>
         <h4 id="%E5%9B%BE%E6%A0%87%E6%8E%A7%E4%BB%B6%E7%9A%84%E8%BE%B9%E8%B7%9D%E8%B0%83%E6%95%B4%EF%BC%9A">图标控件的边距调整：</h4>
         <p>竖屏情况下修改类PortraitPagedViewHandler.setIconAndSnapshotParams。自行调节边距，达到自己要的预期。</p>
         <p>我这边的结果如下：</p>
         <pre class="set-code-show"><code class="language-java">@Override
public void setIconAndSnapshotParams(View iconView, int taskIconMargin, int taskIconHeight,
        FrameLayout.LayoutParams snapshotParams, boolean isRtl) {
    FrameLayout.LayoutParams iconParams =
            (FrameLayout.LayoutParams) iconView.getLayoutParams();
    iconParams.gravity = (isRtl ? END : START);
    iconParams.leftMargin = iconParams.rightMargin = 0;
    int iconMargin = (int) iconView.getContext().getResources()
            .getDimension(R.dimen.task_thumbnail_icon_margin);//10dp
    iconParams.topMargin = snapshotParams.topMargin / 2 + iconMargin * 2;
}</code></pre>
         <p>横屏情况有两个类：</p>
         <p>旋转90度的横屏（音量键和电源键边在上边）：LandscapePagedViewHandler</p>
         <p>旋转270度的横屏（音量键和电源键边在下边）：SeascapePagedViewHandler</p>
         <p>横屏时的边距一开始一直调试都不对，后面才发现原来机器根本没有旋转，就算是横屏，边距的上下左右都是针对竖屏时的方向计算的。比如，LandscapePagedViewHandler时，图标应该是靠近音量键方向的，横着看是在左上角，实际上代码上面实现的时候，图标位置是相对于竖屏来调节的，也就是在竖屏的右上角。SeascapePagedViewHandler类似，图标位置是在左下角。</p>
         <p>LandscapePagedViewHandler：</p>
         <pre class="set-code-show"><code class="language-java">@Override
public void setIconAndSnapshotParams(View iconView, int taskIconMargin, int taskIconHeight,
        FrameLayout.LayoutParams snapshotParams, boolean isRtl) {
    FrameLayout.LayoutParams iconParams =
            (FrameLayout.LayoutParams) iconView.getLayoutParams();
    iconParams.gravity = (isRtl ? END : START);
    iconParams.leftMargin = iconParams.rightMargin = 0;
    int iconMargin = (int) iconView.getContext().getResources()
            .getDimension(R.dimen.task_thumbnail_icon_margin);//10dp
    iconParams.topMargin = snapshotParams.topMargin / 2 + iconMargin * 2;
}</code></pre>
         <p></p>
         <p>SeascapePagedViewHandler：</p>
         <pre class="set-code-show"><code class="language-java">@Override
public void setIconAndSnapshotParams(View mIconView, int taskIconMargin, int taskIconHeight,
        FrameLayout.LayoutParams snapshotParams, boolean isRtl) {
    FrameLayout.LayoutParams iconParams =
            (FrameLayout.LayoutParams) mIconView.getLayoutParams();
    iconParams.gravity = (isRtl ? END : START) | BOTTOM;
    int iconMargin = (int) mIconView.getContext().getResources()
            .getDimension(R.dimen.task_thumbnail_icon_margin);//10dp
    iconParams.leftMargin = -taskIconHeight - iconMargin;
    iconParams.rightMargin = 0;
    iconParams.topMargin = snapshotParams.topMargin / 2;
}</code></pre>
         <p></p>
         <p>最后。因为设置了图标的大小为正方形，且父布局声明了android:clipChildren="false"，所以app名称的长度大于了IconView的宽度也不会被截断。但是获取IconView的宽度会只有图标的宽度，没有包含文字，如果需要包含文字的长度，可以在IconView里面添加对外开放的方法供调用：</p>
         <pre class="set-code-show"><code class="language-java">public int getViewWidth() {
    int width = super.getMeasuredWidth();
    if(mText == null){
        return width;
    }else {
        return width + mTextMargins + getStringWidth(mText); //计算得出图标+边距+文本的宽度
    }
}

//获取文本的宽度
private int getStringWidth(String str) {
    return (int) mTxtPain.measureText(str);
}</code></pre>
         <p></p>
         <h2 id="%E5%A4%9A%E4%BB%BB%E5%8A%A1%E8%83%8C%E6%99%AF%E6%94%B9%E6%88%90%E5%A3%81%E7%BA%B8">多任务背景改成壁纸</h2>
         <p>Android12 多任务背景为白色（浅色模式下），项目有需求改成背景为壁纸。</p>
         <p>一开始我想的是获取当前壁纸然后设置为背景，获取当前壁纸需要读取内存权限，需要自己请求权限，稍微有点麻烦。</p>
         <p>实际上只需要把白色背景改成透明背景，就是桌面壁纸了，修改style文件中的LauncherTheme：</p>
         <pre class="set-code-show"><code class="language-XML">&lt;item name="overviewScrimColor"&gt;@color/overview_scrim&lt;/item&gt;</code></pre>
         <p>改成透明颜色即可：</p>
         <pre class="set-code-show"><code class="language-XML">&lt;item name="overviewScrimColor"&gt;#00000000&lt;/item&gt;</code></pre>
         <p>别忘了还有个深色主题LauncherTheme.Dark也需要修改。</p>
         <p></p>
         <h2 id="%E4%BF%AE%E6%94%B9Task%E9%A2%84%E8%A7%88%E5%9B%BE%E7%9A%84%E5%9C%86%E8%A7%92%E5%8D%8A%E5%BE%84%EF%BC%9A">修改Task预览图的圆角半径：</h2>
         <p>quickstep/res/values/dimens.xml</p>
         <pre class="set-code-show"><code class="language-XML">&lt;dimen name="task_corner_radius_override"&gt;10dp&lt;/dimen&gt;</code></pre>
         <p></p>
         <h2 id="%E6%B8%85%E9%99%A4%E5%85%A8%E9%83%A8%E6%8C%89%E9%92%AE%E7%A7%BB%E5%8A%A8%E5%88%B0%E5%BA%95%E9%83%A8%E6%98%BE%E7%A4%BA">清除全部按钮移动到底部显示</h2>
         <h4 id="%E9%A6%96%E5%85%88%E9%9A%90%E8%97%8F%E5%8E%9F%E6%9C%89%E7%9A%84%E6%B8%85%E9%99%A4%E6%8C%89%E9%92%AE%EF%BC%9A">首先隐藏原有的清除按钮：</h4>
         <p>原先的全部清除按钮mClearAllButton在RecentsView里面声明，在构造函数里面找到他的点击事件，注释掉：</p>
         <pre class="set-code-show"><code class="language-java">mClearAllButton = (ClearAllButton) LayoutInflater.from(context)
                .inflate(R.layout.overview_clear_all_button, this, false);
//        mClearAllButton.setOnClickListener(this::dismissAllTasks);</code></pre>
         <p>另外把点击事件响应的方法dismissAllTasks改成public声明，后面需要在新的底部按钮事件上面去调用。</p>
         <p>然后继续修改：</p>
         <pre class="set-code-show"><code class="language-java"> public boolean isClearAllHidden() {
//        return mClearAllButton.getAlpha() != 1f;
        return true;
    }</code></pre>
         <p>接着找到所有addView(mClearAllButton)，注释掉，不要让他add</p>
         <p>这时候原全部清除按钮就已经移除掉了。但是这个时候横屏会有问题，SeascapePagedViewHandler的时候无法滑动，LandscapePagedViewHandler就没有问题。因为我这边的项目要求横屏不需要适配，所以我没有继续去研究这个原因，把addView(mClearAllButton)加回去就不会有这个问题，这个需要自行研究解决。网上的方法在findViewById找到mClearAllButton之后给他设置隐藏，没有注释掉addView，我这边一开始也是这样做的，但是会导致在倒数第二个taskView那里滑动不了了，所以我这边是去掉addView的方式。</p>
         <p>我这边不需要适配横屏，也就是横屏的时候，依然采用竖屏的显示方式，注释掉旋转角度的代码：</p>
         <p>quickstep/src/com/android/quickstep/util/RecentsOrientedState.java</p>
         <p>让每一个角度都是竖屏的参数类：mOrientationHandler = PagedOrientationHandler.PORTRAIT;</p>
         <pre class="set-code-show"><code class="language-java">private boolean updateHandler() {
        mRecentsActivityRotation = inferRecentsActivityRotation(mDisplayRotation);
        /*if (mRecentsActivityRotation == mTouchRotation || (isRecentsActivityRotationAllowed()
                &amp;&amp; (mFlags &amp; FLAG_SWIPE_UP_NOT_RUNNING) != 0)) {
            mOrientationHandler = PagedOrientationHandler.PORTRAIT;
        } else if (mTouchRotation == ROTATION_90) {
            mOrientationHandler = PagedOrientationHandler.LANDSCAPE;
        } else if (mTouchRotation == ROTATION_270) {
            mOrientationHandler = PagedOrientationHandler.SEASCAPE;
        } else {*/
            mOrientationHandler = PagedOrientationHandler.PORTRAIT;
//        }
        if (DEBUG) {
            Log.d(TAG, "current RecentsOrientedState: " + this);
        }

        int oldStateId = mStateId;
        // Each SurfaceRotation value takes two bits
        mStateId = (((((mFlags &lt;&lt; 2)
                | mDisplayRotation) &lt;&lt; 2)
                | mTouchRotation) &lt;&lt; 3)
                | (mRecentsRotation &lt; 0 ? 7 : mRecentsRotation);
        return mStateId != oldStateId;
    }</code></pre>
         <h4 id="%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E5%BA%95%E9%83%A8%E6%B8%85%E9%99%A4%E5%85%A8%E9%83%A8%E6%8C%89%E9%92%AE%EF%BC%9A">添加新的底部清除全部按钮：</h4>
         <p>底部的自定义view（OverviewActionsView）原先有个截图的按钮，我们仿着它来添加一个新按钮。</p>
         <p>布局文件quickstep/res/layout/overview_actions_container.xml添加新按钮，并且把截图按钮设置隐藏：</p>
         <pre class="set-code-show"><code class="language-XML">&lt;Button
    android:id="@+id/action_screenshot"
    style="@style/OverviewActionButton"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:drawableStart="@drawable/ic_screenshot"
    android:visibility="gone"
    android:text="@string/action_screenshot"
    android:theme="@style/ThemeControlHighlightWorkspaceColor" /&gt;

&lt;Button
    android:id="@+id/action_clear_all"
    style="@style/OverviewActionButton"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:drawableTop="@drawable/icon_clear_all"
    android:text="@string/recents_clear_all"
    android:theme="@style/ThemeControlHighlightWorkspaceColor" /&gt;</code></pre>
         <p>这个OverviewActionsView高度是在quickstep/res/values/dimens.xml这里定义了的，我这里新增的按钮图标和文字上下显示，高度不够，文字看不到，所以需要修改高度：</p>
         <pre class="set-code-show"><code class="language-XML">&lt;dimen name="overview_actions_height"&gt;96dp&lt;/dimen&gt;</code></pre>
         <p>然后再在类OverviewActionsView设置监听：</p>
         <pre class="set-code-show"><code class="language-java">@Override
protected void onFinishInflate() {
    super.onFinishInflate();
    findViewById(R.id.action_screenshot).setOnClickListener(this);
    findViewById(R.id.action_clear_all).setOnClickListener(this);
     ......
}</code></pre>
         <p>在onClick里面可以看到他是通过callback来调用点击事件的，添加清除全部的点击响应：</p>
         <pre class="set-code-show"><code class="language-java">@Override
public void onClick(View view) {
    if (mCallbacks == null) {
        return;
    }
    int id = view.getId();
    if (id == R.id.action_screenshot) {
        mCallbacks.onScreenshot();
    } else if (id == R.id.action_split) {
        mCallbacks.onSplit();
    } else if (id == R.id.action_clear_all) {
        mCallbacks.onClearAll();
    }
}</code></pre>
         <p>在callback里面添加.onClearAll()方法：</p>
         <p>callback的类是TaskOverlayFactory.java：</p>
         <p>接口增加方法：</p>
         <pre class="set-code-show"><code class="language-java">public interface OverlayUICallbacks {
    /** User has indicated they want to screenshot the current task. */
    void onScreenshot();

    /** User wants to start split screen with current app. */
    void onSplit();

    /**
     * 清除全部
     */
    void onClearAll();
}</code></pre>
         <p>接口实现（之前改成public的dismissAllTasks方法就可以排上用场了）:</p>
         <pre class="set-code-show"><code class="language-java">protected class OverlayUICallbacksImpl implements OverlayUICallbacks {
    protected final boolean mIsAllowedByPolicy;
    protected final Task mTask;

    public OverlayUICallbacksImpl(boolean isAllowedByPolicy, Task task) {
        mIsAllowedByPolicy = isAllowedByPolicy;
        mTask = task;
    }

    @SuppressLint("NewApi")
    public void onScreenshot() {
        endLiveTileMode(() -&gt; saveScreenshot(mTask));
    }

    public void onSplit() {
        endLiveTileMode(TaskOverlay.this::enterSplitSelect);
    }

    public void onClearAll() {
        RecentsView recentsView = mThumbnailView.getTaskView().getRecentsView();
        recentsView.dismissAllTasks(null);
    }
}</code></pre>
         <p></p>
         <h2 id="%E6%9C%80%E8%BF%91%E4%BB%BB%E5%8A%A1%E4%B8%BA%E7%A9%BA%E6%97%B6%E7%9A%84%E5%9B%BE%E7%89%87%E3%80%81%E5%AD%97%E4%BD%93%E9%A2%9C%E8%89%B2%E7%AD%89">最近任务为空时的图片、字体颜色等</h2>
         <p>RecentsView的构造函数里面：</p>
         <pre class="set-code-show"><code class="language-java">//        mEmptyIcon = context.getDrawable(R.drawable.ic_empty_recents);//后台任务为空时的图片资源，需替换
        mEmptyIcon = context.getDrawable(R.drawable.icon_recent_empty);
        mEmptyIcon.setCallback(this);
        mEmptyMessage = context.getText(R.string.recents_empty_message);
        mEmptyMessagePaint = new TextPaint();
//        mEmptyMessagePaint.setColor(Themes.getAttrColor(context, android.R.attr.textColorPrimary)); //字体颜色改成下面的白色
        mEmptyMessagePaint.setColor(Color.WHITE);</code></pre>
         <p></p>
         <h2 id="%E7%BC%A9%E6%94%BE%E6%95%88%E6%9E%9C">缩放效果</h2>
         <p>RecentsView里面的updateCurveProperties方法：查看Android11以前的代码都是有做缩放效果的，但是在Android12之后去掉了，且去掉的代码挺多的，不好按照以前的代码来恢复，只能自己去研究了。</p>
         <p>我这边不适配横屏，所以只是竖屏情况：</p>
         <pre class="set-code-show"><code class="language-java">   /**
     * Scales and adjusts translation of adjacent pages as if on a curved carousel.
     */
    public void updateCurveProperties() {
        if (getPageCount() == 0 || getPageAt(0).getMeasuredWidth() == 0) {
            return;
        }
        int scroll = mOrientationHandler.getPrimaryScroll(this);
//        mClearAllButton.onRecentsViewScroll(scroll, mOverviewGridEnabled);

        //TaskView缩放
        if(mOrientationHandler instanceof com.android.launcher3.touch.PortraitPagedViewHandler){
            final int pageCount = getPageCount();
            for (int i = 0; i &lt; pageCount; i++) {
                View page = getPageAt(i);
                float pageX = mOrientationHandler.getChildStart(page) - 200;

                float d = scroll * 1f - pageX;
                d = d &gt;= 0 ? d : -d;

                float scale = 1f - d/5460;
                page.setScaleX(scale);
                page.setScaleY(scale);
            }
        }
    }</code></pre>
         <p>缩放的参数我这边通过scroll与page的X轴的值的规律，计算出这么一个5460的值，具体是这么计算的我忘了，稍微有些小复杂。经过以上的计算缩放之后。中间最大的缩放是0.99...的大小，然后两边是一样大的是0.88...的大小，再往下一个就是0.7...的大小，后面的看不到，随便他缩放的大小了。</p>
         <p>这里有两个小bug：</p>
         <p>1、从app进入最近任务，滑动task列表，第一个taskView的缩放只对背景生效，内容不会缩放</p>
         <p>2、移除task卡片，其他task卡片自动推进无缩放动画，推进完之后才突变的变成该有的缩放大小。</p>
         <p>第一个bug是因为第一个task任务卡片窗口是实时的，也就是那个应用Activity并没有暂停，比如正在播放视频，它进入后台任务之后依然在播放视频。但是在我自己手上的MIUI的机器来说，进入后台任务之后马上就是暂停了当前窗口的内容。这个是否允许实时窗口是由一个配置值决定的，我们可以看到很多个ENABLE_QUICKSTEP_LIVE_TILE.get()的判断，全局搜索ENABLE_QUICKSTEP_LIVE_TILE，可以看到他的声明在src/com/android/launcher3/config/FeatureFlags.java里面，修改ture为false，即不允许实时窗口，问题解决：</p>
         <pre class="set-code-show"><code class="language-java">public static final BooleanFlag ENABLE_QUICKSTEP_LIVE_TILE = getDebugFlag(
        "ENABLE_QUICKSTEP_LIVE_TILE", false, "Enable live tile in Quickstep overview");</code></pre>
         <p>第二个问题有两种思路，第一种是在createTaskDismissAnimation方法里面去和位移动画一起做缩放动画，第二种是考虑在滑动完之后再做一个缩放到目标大小的动画，可以显得不那么突兀。</p>
         <p>我这边使用第一种思路，在位移动画的时候，根据移动的dismissTranslationX计算出当前的缩放大小，然后设置给taskView：</p>
         <p>修改TaskView中原来定义的 DISMISS_TRANSLATION_X：</p>
         <pre class="set-code-show"><code class="language-java">private static final FloatProperty&lt;TaskView&gt; DISMISS_TRANSLATION_X =
        new FloatProperty&lt;TaskView&gt;("dismissTranslationX") {
            @Override
            public void setValue(TaskView taskView, float v) {
                int start = taskView.getLeft();
                int naxtStart = start + 631;
                float currentScale = getScaleWithX(taskView, start);
                float nextScale = getScaleWithX(taskView, naxtStart);
                float targetScale = (nextScale - currentScale) * v / 631f + currentScale;
                taskView.setScaleX(targetScale);
                taskView.setScaleY(targetScale);
                taskView.setDismissTranslationX(v);
            }

            private float getScaleWithX(TaskView taskView, int start){
                int scrollX = taskView.getRecentsView().getScrollX();
                int x = scrollX - start + 200;
                x = x &gt; 0 ? x : -x;
                return  1f - x / 5460f;
            }

            @Override
            public Float get(TaskView taskView) {
                return taskView.mDismissTranslationX;
            }
        };</code></pre>
         <p>这些数值的计算方式是根据打印当前TaskView的taskView.getLeft()、taskView.getScaleX()、taskView.getRecentsView().getScrollX()、v等值来查找规律，在上滑删除的时候，值的变化关系算出的值，雀食有些小复杂。</p>
         <p>至此，缩放功能就完成了。</p></div></div>
      </article></div>
    </main></div><div class="recommend-right align-items-stretch clearfix" id="rightAside" data-type="recommend"></div></div>
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blog_editor_html/release1.6.12/ckeditor/plugins/chart/chart.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/lib/cboxEditor/1.1.6/embed-editor.min.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blog_editor_html/release1.6.12/ckeditor/plugins/codesnippet/lib/highlight/styles/atom-one-light.css">
  <script>
    $(".MathJax").remove();
    if ($('div.markdown_views pre.prettyprint code.hljs').length > 0) {
      $('div.markdown_views')[0].className = 'markdown_views';
    }
  </script>
  <script type="text/javascript" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blog_mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      "HTML-CSS": {
        linebreaks: { automatic: true, width: "94%container" },
        imageFont: null
      },
      tex2jax: {
      preview: "none",
      ignoreClass:"title-article"
      },
      mml2jax: {
      preview: 'none'
      }
    });
  </script>
 </body> 
</html>